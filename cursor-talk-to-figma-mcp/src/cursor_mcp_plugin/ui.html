<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Token Link</title>
  <style>
    :root {
      --bg-color: #0a0a0a; /* neutral-950 */
      --card-bg: #171717; /* neutral-900 */
      --border-color: #262626; /* neutral-800 */
      --text-main: #fafafa; /* neutral-50 */
      --text-muted: #a3a3a3; /* neutral-400 */
      --primary: #C7E02A; /* acid green */
      --primary-hover: #b4cc25;
      --success: #22c55e;
      --error: #ef4444;
      --bg-panel: rgba(10, 10, 10, 0.5);
      
      --font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family);
      background-color: var(--bg-color);
      color: var(--text-main);
      margin: 0;
      padding: 0;
      /* Let Figma control the plugin window size */
      -webkit-font-smoothing: antialiased;
    }

    .app-container {
      width: 100%;
      padding: 12px;
      display: flex;
      justify-content: center;
      height: 100%;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .main-card {
      width: 100%;
      max-width: 360px;
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* Glow Effect */
    .glow-effect {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 128px;
      height: 128px;
      background-color: transparent;
      filter: blur(100px);
      opacity: 0.1;
      pointer-events: none;
      z-index: 0;
    }

    .card-content {
      position: relative;
      z-index: 10;
      padding: 16px; /* Reduced from 20px */
      flex: 1 1 auto; /* Take up all available vertical space above footer */
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px; /* Reduced from 20px */
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background-color: transparent;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: black;
    }

    .header-text h1 {
      font-size: 16px;
      font-weight: 600;
      line-height: 1.2;
    }

    .header-text p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .badge {
      font-size: 10px;
      background-color: var(--border-color);
      padding: 2px 8px;
      border-radius: 999px;
      color: var(--text-muted);
      font-family: monospace;
    }

    /* Tabs */
    .tabs-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      background-color: rgba(10, 10, 10, 0.5);
      padding: 4px;
      border-radius: 8px;
      margin-bottom: 16px; /* Reduced from 20px */
    }

    .tab-trigger {
      background: none;
      border: none;
      color: var(--text-muted);
      padding: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .tab-trigger.active {
      background-color: var(--border-color);
      color: var(--primary);
    }

    .tab-trigger:hover:not(.active) {
      color: var(--text-main);
    }

    /* Content Areas */
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Connection Panel */
    .status-panel {
      background-color: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px; /* Reduced from 24px 16px */
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px; /* Reduced from 20px */
      margin-bottom: 16px;
    }

    .status-display {
      position: relative;
      width: 80px; /* Reduced from 96px */
      height: 80px; /* Reduced from 96px */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .status-circle {
      width: 80px; /* Reduced from 96px */
      height: 80px; /* Reduced from 96px */
      border-radius: 50%;
      border: 2px solid;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 2;
      backdrop-filter: blur(4px);
      transition: all 0.5s;
    }

    /* Status Colors */
    .status-panel[data-connected="false"] .status-circle {
      background-color: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.5);
      color: var(--error);
    }

    .status-panel[data-connected="true"] .status-circle {
      background-color: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.5);
      color: var(--success);
    }

    /* Rings Animation */
    .rings-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: none; /* Hidden by default */
    }

    .status-panel[data-connected="true"] .rings-container {
      display: block;
    }

    .ring {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background-color: rgba(34, 197, 94, 0.2);
      width: 100%;
      height: 100%;
    }

    .ring-1 {
      animation: pulseRing 2s infinite ease-out;
    }

    .ring-2 {
      animation: pulseRing 2s infinite ease-out 0.5s;
    }

    @keyframes pulseRing {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.5; }
      100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
    }

    .status-text-container {
      text-align: center;
      width: 100%;
    }

    .status-text-container h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      transition: color 0.3s;
    }

    .status-panel[data-connected="true"] h3 { color: var(--success); }
    .status-panel[data-connected="false"] h3 { color: var(--text-main); }

    .status-message {
      font-size: 14px;
      color: var(--text-muted);
      max-width: 200px;
      margin: 0 auto;
      line-height: 1.4;
    }

    .detail-row {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .mono {
      font-family: monospace;
      color: var(--text-main);
      word-break: break-all;
    }

    /* Button */
    .btn-primary {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    /* Connect State */
    .btn-connect {
      background-color: var(--primary);
      color: black;
      box-shadow: 0 4px 12px rgba(199, 224, 42, 0.2);
    }
    .btn-connect:hover:not(:disabled) {
      background-color: var(--primary-hover);
    }

    /* Disconnect State */
    .btn-disconnect {
      background-color: var(--border-color);
      color: var(--text-muted);
    }
    .btn-disconnect:hover:not(:disabled) {
      background-color: #333;
      color: var(--text-main);
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0,0,0,0.1);
      border-left-color: #000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* About Panel */
    .about-panel {
      background-color: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      min-height: 300px;
    }

    .about-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }

    .about-icon-bg {
      width: 48px;
      height: 48px;
      background-color: rgba(255,255,255,0.05);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-main);
    }

    .info-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .info-label { color: var(--text-muted); }
    .info-value { font-weight: 500; }
    .text-green { color: var(--success); }

    .description {
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-muted);
    }

    /* Footer Line */
    .footer-line {
      height: 4px;
      width: 100%;
      background-color: var(--border-color);
      transition: background-color 0.5s;
    }

    .footer-line.connected {
      background-color: var(--success);
    }

    .hidden { display: none !important; }

    /* Progress Bar Styles */
    #progress-container {
      background-color: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      font-size: 13px;
    }
    
    #progress-container h2 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 8px;
    }

    #progress-message {
      color: var(--text-muted);
      margin-bottom: 8px;
      font-size: 12px;
    }

    .progress-track {
      width: 100%;
      background-color: var(--border-color);
      border-radius: 4px;
      height: 6px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background-color: transparent;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .operation-complete { color: var(--success); }
    .operation-error { color: var(--error); }

    /* Custom scrollbar for About panel */
    .about-panel::-webkit-scrollbar {
      width: 6px;
    }

    .about-panel::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.2);
      border-radius: 999px;
    }

    .about-panel::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.25);
      border-radius: 999px;
    }

    .about-panel::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.4);
    }

    .link {
      color: var(--primary);
      text-decoration: none;
      cursor: pointer;
    }

    .link:hover {
      text-decoration: underline;
    }

  </style>
</head>
<body>

  <div class="app-container">
    <div class="main-card">
      <!-- Background Glow -->
      <div class="glow-effect"></div>

      <div class="card-content">
        
        <!-- Header -->
        <header class="header">
          <div class="logo-container">
            <div class="logo-icon">
              <!-- Inline Logo SVG -->
              <svg viewBox="0 0 32 32" width="24" height="24" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_token_link_logo)">
                  <rect width="32" height="32" rx="7.88177" fill="#91BA00" />
                  <path d="M23.7911 16.7803C24.079 16.4924 24.5721 16.6965 24.5724 17.1035V24.2285C24.5724 24.7335 24.1623 25.1436 23.6573 25.1436H16.5323C16.1253 25.1432 15.9212 24.6502 16.2091 24.3623L23.7911 16.7803ZM14.5157 6.90234C15.0182 6.85253 15.4287 7.26664 15.4288 7.77148V24.2285C15.4288 24.7335 15.0182 25.1475 14.5157 25.0977C9.89514 24.6393 6.28625 20.7412 6.28625 16C6.2864 11.2589 9.89521 7.36062 14.5157 6.90234ZM23.6573 6.85742C24.1622 6.85742 24.5723 7.26664 24.5724 7.77148V14.8965C24.5724 15.3038 24.0791 15.5077 23.7911 15.2197L16.2091 7.6377C15.9216 7.34977 16.1255 6.85775 16.5323 6.85742H23.6573Z" fill="#0D0D12" />
                </g>
                <defs>
                  <clipPath id="clip0_token_link_logo">
                    <rect width="32" height="32" fill="white" />
                  </clipPath>
                </defs>
              </svg>
            </div>
            <div class="header-text">
              <h1>Token Link</h1>
              <p>Figma â†” Tokens via MCP</p>
            </div>
          </div>
          <div class="badge">v1.0.0</div>
        </header>

        <!-- Tabs Navigation -->
        <div class="tabs-list">
          <button class="tab-trigger active" data-tab="connection">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
            Connection
          </button>
          <button class="tab-trigger" data-tab="about">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            About
          </button>
        </div>

        <!-- Connection Tab -->
        <div id="tab-connection" class="tab-content active">
          <div class="status-panel" data-connected="false">
            
            <div class="status-display">
              <div class="rings-container">
                <div class="ring ring-1"></div>
                <div class="ring ring-2"></div>
              </div>
              
              <div class="status-circle">
                <svg id="status-icon-connected" class="status-icon hidden" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                <svg id="status-icon-disconnected" class="status-icon" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="12.41 6.75 13 2 10.57 4.92"></polyline><polyline points="18.57 12.91 21 10 15.66 10"></polyline><polyline points="8 8 3 14 12 14 11 22 16 16"></polyline><line x1="1" y1="1" x2="23" y2="23"></line></svg>
              </div>
            </div>

            <div class="status-text-container">
              <h3 id="status-label">Disconnected</h3>
              <div id="status-details" class="hidden">
                <div class="detail-row">Port: <span class="mono" id="port-display">3055</span></div>
                <div class="detail-row">Channel: <span class="mono" id="channel-display">figma-mcp-default</span></div>
              </div>
              <p id="status-message" class="status-message">Connect to your local MCP server to read Figma variables and apply matching design tokens.</p>
            </div>

          </div>

          <button id="connect-btn" class="btn-primary btn-connect">
            <span class="btn-text">Connect Server</span>
            <div class="spinner hidden"></div>
          </button>

          <!-- Progress Section -->
          <div id="progress-container" class="hidden">
            <h2>Operation Progress</h2>
            <div id="progress-message">No operation in progress</div>
            <div class="progress-track">
              <div id="progress-bar" class="progress-fill" style="width: 0%;"></div>
            </div>
            <div class="progress-stats">
              <div id="progress-status">Not started</div>
              <div id="progress-percentage">0%</div>
            </div>
          </div>
        </div>

        <!-- About Tab -->
        <div id="tab-about" class="tab-content">
          <div class="about-panel"> 
            <div class="info-list">
              <div class="info-item">
                <span class="info-label">Maintainer</span>
                <span class="info-value">Vincent Koopmans</span>
              </div>
              <div class="info-item">
                <span class="info-label">Contact</span>
                <span class="info-value">
                  <a class="link" onclick="window.open('mailto:vincent@createnew.co', '_blank')">vincent@createnew.co</a>
                </span>
              </div>
            </div>

            <div class="description">
              <p>Token Link bridges your Figma components and your design tokens using the Model Context Protocol (MCP). It reads variables and styles from selections, matches them to your token sets, and can intelligently apply tokens back into Figma, so components become consistently tokenized without manual plumbing. Built as an extended, token-focused fork of the original <a class="link" onclick="window.open('https://github.com/grab/cursor-talk-to-figma-mcp', '_blank')">cursor-talk-to-figma-mcp</a> project by Grab.</p>
            </div>
          </div>
        </div>

      </div>
      
      <!-- Footer Status Line -->
      <div id="footer-line" class="footer-line"></div>
    </div>
  </div>

  <script>
    // ----------------------------------------------------
    // STATE & CONFIGURATION
    // ----------------------------------------------------
    const state = {
      isConnected: false,
      isConnecting: false,
      serverPort: 3055,
      channelName: "figma-mcp-default",
      socket: null,
      pendingRequests: new Map(),
      channel: null,
      statusMessageText: null
    };

    // ----------------------------------------------------
    // DOM ELEMENTS
    // ----------------------------------------------------
    const btnConnect = document.getElementById('connect-btn');
    const btnText = btnConnect.querySelector('.btn-text');
    const spinner = btnConnect.querySelector('.spinner');
    
    const statusPanel = document.querySelector('.status-panel');
    const statusLabel = document.getElementById('status-label');
    const statusMessage = document.getElementById('status-message');
    const statusDetails = document.getElementById('status-details');
    const iconConnected = document.getElementById('status-icon-connected');
    const iconDisconnected = document.getElementById('status-icon-disconnected');
    const portDisplay = document.getElementById('port-display');
    const channelDisplay = document.getElementById('channel-display');
    
    const footerLine = document.getElementById('footer-line');
    
    // Tabs
    const tabs = document.querySelectorAll('.tab-trigger');
    const contents = document.querySelectorAll('.tab-content');
    
    // Progress
    const progressContainer = document.getElementById("progress-container");
    const progressBar = document.getElementById("progress-bar");
    const progressMessageEl = document.getElementById("progress-message");
    const progressStatusEl = document.getElementById("progress-status");
    const progressPercentageEl = document.getElementById("progress-percentage");

    // ----------------------------------------------------
    // RENDERING LOGIC
    // ----------------------------------------------------
    function renderConnectionState() {
      // 1. Panel State Attribute (for CSS styling)
      statusPanel.setAttribute('data-connected', state.isConnected);

      // 2. Icon Visibility
      if (state.isConnected) {
        iconConnected.classList.remove('hidden');
        iconDisconnected.classList.add('hidden');
      } else {
        iconConnected.classList.add('hidden');
        iconDisconnected.classList.remove('hidden');
      }

      // 3. Text Content
      statusLabel.textContent = state.isConnected ? 'Connected' : 'Disconnected';
      
      if (state.isConnected) {
        statusMessage.classList.add('hidden');
        statusDetails.classList.remove('hidden');
        portDisplay.textContent = state.serverPort;
        channelDisplay.textContent = state.channel || state.channelName;
      } else {
        statusMessage.classList.remove('hidden');
        statusDetails.classList.add('hidden');
        // Show custom message if exists, otherwise default prompt
        statusMessage.textContent = state.statusMessageText || "Connect to your local MCP server to read Figma variables and apply matching design tokens.";
      }

      // 4. Button Styling & Text
      btnConnect.disabled = state.isConnecting;
      
      if (state.isConnecting) {
        btnConnect.className = 'btn-primary btn-connect';
        btnText.textContent = 'Connecting...';
        spinner.classList.remove('hidden');
      } else {
        spinner.classList.add('hidden');
        
        if (state.isConnected) {
          btnConnect.className = 'btn-primary btn-disconnect';
          // Include icon in HTML
          btnText.innerHTML = `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>
            Disconnect
          `;
        } else {
          btnConnect.className = 'btn-primary btn-connect';
          btnText.textContent = 'Connect Server';
        }
      }

      // 5. Footer Line
      if (state.isConnected) {
        footerLine.classList.add('connected');
      } else {
        footerLine.classList.remove('connected');
      }
    }

    function updateConnectionStatus(isConnected, message) {
      state.isConnected = isConnected;
      state.statusMessageText = message || null;
      state.isConnecting = false;
      renderConnectionState();
    }

    // ----------------------------------------------------
    // WEBSOCKET / MCP LOGIC
    // ----------------------------------------------------

    async function connectToServer(port) {
      try {
        if (state.isConnected && state.socket) {
          return;
        }

        state.serverPort = port;
        state.socket = new WebSocket(`ws://localhost:${port}`);

        state.socket.onopen = () => {
          const channelName = state.channelName || "figma-mcp-default";
          state.channel = channelName;
          state.socket.send(
            JSON.stringify({
              type: "join",
              channel: channelName.trim(),
            })
          );
        };

        state.socket.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.type === "system") {
              if (data.message && data.message.result) {
                // Connected successfully
                updateConnectionStatus(true, `Joined channel: ${data.channel}`);
                state.channel = data.channel;
                
                // Notify plugin
                parent.postMessage({
                  pluginMessage: {
                    type: "notify",
                    message: `Connected to Cursor MCP server on port ${port} in channel: ${data.channel}`,
                  },
                }, "*");
              }
            } else if (data.type === "error") {
              console.error("Error:", data.message);
              updateConnectionStatus(false, `Error: ${data.message}`);
              state.socket.close();
            }
            handleSocketMessage(data);
          } catch (error) {
            console.error("Error parsing message:", error);
          }
        };

        state.socket.onclose = () => {
          state.socket = null;
          updateConnectionStatus(false, "Disconnected from server");
        };

        state.socket.onerror = (error) => {
          console.error("WebSocket error:", error);
          updateConnectionStatus(false, "Connection error");
          state.socket = null;
        };

      } catch (error) {
        console.error("Connection error:", error);
        updateConnectionStatus(false, `Connection error: ${error.message}`);
      }
    }

    function disconnectFromServer() {
      if (state.socket) {
        state.socket.close();
        state.socket = null;
        updateConnectionStatus(false, "Disconnected manually");
      }
    }

    async function handleSocketMessage(payload) {
      const data = payload.message;
      if (!data) return;

      // Response to previous request
      if (data.id && state.pendingRequests.has(data.id)) {
        const { resolve, reject } = state.pendingRequests.get(data.id);
        state.pendingRequests.delete(data.id);
        if (data.error) reject(new Error(data.error));
        else resolve(data.result);
        return;
      }

      // New command from server
      if (data.command) {
        try {
          parent.postMessage({
            pluginMessage: {
              type: "execute-command",
              id: data.id,
              command: data.command,
              params: data.params,
            },
          }, "*");
        } catch (error) {
          sendErrorResponse(data.id, error.message || "Error executing command");
        }
      }
    }

    function sendSuccessResponse(id, result) {
      if (!state.isConnected || !state.socket) return;
      state.socket.send(JSON.stringify({
        id,
        type: "message",
        channel: state.channel,
        message: { id, result },
      }));
    }

    function sendErrorResponse(id, errorMessage) {
      if (!state.isConnected || !state.socket) return;
      state.socket.send(JSON.stringify({
        id,
        type: "message",
        channel: state.channel,
        message: { id, error: errorMessage, result: {} },
      }));
    }

    function sendProgressUpdateToServer(progressData) {
      if (!state.isConnected || !state.socket) return;
      state.socket.send(JSON.stringify({
        id: progressData.commandId,
        type: "progress_update",
        channel: state.channel,
        message: {
          id: progressData.commandId,
          type: "progress_update",
          data: progressData
        }
      }));
    }

    // ----------------------------------------------------
    // PROGRESS UI
    // ----------------------------------------------------
    function updateProgressUI(progressData) {
      progressContainer.classList.remove("hidden");
      
      const progress = progressData.progress || 0;
      progressBar.style.width = `${progress}%`;
      progressPercentageEl.textContent = `${progress}%`;
      
      progressMessageEl.textContent = progressData.message || "Operation in progress";
      
      progressStatusEl.className = ""; // reset colors
      if (progressData.status === 'started') {
        progressStatusEl.textContent = "Started";
      } else if (progressData.status === 'in_progress') {
        progressStatusEl.textContent = "In Progress";
      } else if (progressData.status === 'completed') {
        progressStatusEl.textContent = "Completed";
        progressStatusEl.classList.add("operation-complete");
        // Auto-hide after 3s
        setTimeout(() => {
          progressContainer.classList.add("hidden");
        }, 3000);
      } else if (progressData.status === 'error') {
        progressStatusEl.textContent = "Error";
        progressStatusEl.classList.add("operation-error");
      }
    }

    // ----------------------------------------------------
    // INTERACTION HANDLERS
    // ----------------------------------------------------
    btnConnect.addEventListener('click', () => {
      if (state.isConnecting) return;

      if (state.isConnected) {
        // Disconnect
        state.isConnecting = true; 
        state.statusMessageText = "Disconnecting...";
        renderConnectionState();
        
        // Small delay for visual feedback
        setTimeout(() => {
          disconnectFromServer();
        }, 500);
      } else {
        // Connect
        state.isConnecting = true;
        state.statusMessageText = "Connecting...";
        renderConnectionState();
        
        setTimeout(() => {
          connectToServer(state.serverPort);
        }, 500);
      }
    });

    // Tabs Logic
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        contents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        const targetId = `tab-${tab.dataset.tab}`;
        document.getElementById(targetId).classList.add('active');
      });
    });

    // ----------------------------------------------------
    // MESSAGE LISTENER (FROM FIGMA)
    // ----------------------------------------------------
    window.onmessage = (event) => {
      const message = event.data.pluginMessage;
      if (!message) return;

      switch (message.type) {
        case "init-settings":
          if (message.settings && message.settings.channelName) {
            state.channelName = message.settings.channelName;
          }
          break;
        case "connection-status":
          // Typically not used if we manage state here, but good for sync
          updateConnectionStatus(message.connected, message.message);
          break;
        case "auto-connect":
          if (!state.isConnected) btnConnect.click();
          break;
        case "auto-disconnect":
          if (state.isConnected) btnConnect.click();
          break;
        case "command-result":
          sendSuccessResponse(message.id, message.result);
          break;
        case "command-error":
          sendErrorResponse(message.id, message.error);
          break;
        case "command_progress":
          updateProgressUI(message);
          sendProgressUpdateToServer(message);
          break;
      }
    };

    // Initial Render
    renderConnectionState();

  </script>
</body>
</html>
